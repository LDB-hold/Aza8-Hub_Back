generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

enum Status {
  ativo
  suspenso
}

enum ActorType {
  user
  service
}

enum AuthProvider {
  internal
  idp
}

enum ApiKeyProfile {
  read_only
  write
  admin
}

enum OutboxStatus {
  pending
  processing
  done
  failed
  dead
}

enum WebhookStatus {
  ativo
  suspenso
}

enum WebhookDeliveryStatus {
  pending
  delivered
  failed
  dead
}

model Tenant {
  id              String   @id @default(uuid()) @db.Uuid
  slug            String   @unique(map: "uq_tenant_slug")
  name            String
  status          Status   @default(ativo)
  suspendedReason String?  @map("suspended_reason")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  users           User[]
  groups          Group[]
  userGroups      UserGroup[]
  groupPermissions GroupPermission[]
  apiKeys         ApiKey[]
  tenantPackages  TenantPackage[]
  overrides       TenantToolOverride[]
  auditLogs       AuditLog[]
  idempotencyKeys IdempotencyKey[]
  outboxJobs      OutboxJob[]
  usageMetrics    UsageMetric[]
  integrationCredentials IntegrationCredential[]
  branding        TenantBranding?
  config          TenantConfig?
  webhookSubscriptions WebhookSubscription[]
  webhookDeliveries    WebhookDelivery[]
  apiKeyToolActions ApiKeyToolAction[]
  refreshTokens   RefreshToken[]

  @@map("tenant")
}

model Tool {
  id          String   @id @default(uuid()) @db.Uuid
  key         String   @unique(map: "uq_tool_key")
  name        String
  description String?
  status      Status   @default(ativo)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  actions     ToolAction[]
  overrides   TenantToolOverride[]

  @@map("tool")
}

model ToolAction {
  id          String   @id @default(uuid()) @db.Uuid
  toolId      String   @map("tool_id") @db.Uuid
  key         String   @unique(map: "uq_tool_action_key")
  name        String
  description String?
  status      Status   @default(ativo)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  tool        Tool     @relation(fields: [toolId], references: [id], onDelete: Restrict, map: "fk_tool_action_tool_id")
  groupPermissions GroupPermission[]
  apiKeyToolActions ApiKeyToolAction[]
  packageToolActions PackageToolAction[]
  overrides   TenantToolOverride[]
  usageMetrics UsageMetric[]

  @@index([toolId], map: "idx_tool_action_tool_id")
  @@map("tool_action")
}

model Package {
  id          String   @id @default(uuid()) @db.Uuid
  key         String   @unique(map: "uq_package_key")
  name        String
  description String?
  status      Status   @default(ativo)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  toolActions PackageToolAction[]
  tenantPackages TenantPackage[]

  @@map("package")
}

model PackageToolAction {
  id           String   @id @default(uuid()) @db.Uuid
  packageId    String   @map("package_id") @db.Uuid
  toolActionId String   @map("tool_action_id") @db.Uuid
  createdAt    DateTime @default(now()) @map("created_at")

  pkg          Package    @relation(fields: [packageId], references: [id], onDelete: Cascade, map: "fk_package_tool_action_package_id")
  toolAction   ToolAction @relation(fields: [toolActionId], references: [id], onDelete: Cascade, map: "fk_package_tool_action_tool_action_id")

  @@unique([packageId, toolActionId], map: "uq_package_tool_action_package_id_tool_action_id")
  @@index([toolActionId], map: "idx_package_tool_action_tool_action_id")
  @@map("package_tool_action")
}

model TenantPackage {
  id         String   @id @default(uuid()) @db.Uuid
  tenantId   String   @map("tenant_id") @db.Uuid
  packageId  String   @map("package_id") @db.Uuid
  status     Status   @default(ativo)
  assignedAt DateTime @default(now()) @map("assigned_at")
  expiresAt  DateTime? @map("expires_at")

  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade, map: "fk_tenant_package_tenant_id")
  pkg        Package  @relation(fields: [packageId], references: [id], onDelete: Restrict, map: "fk_tenant_package_package_id")

  @@unique([tenantId, packageId], map: "uq_tenant_package_tenant_id_package_id")
  @@index([tenantId], map: "idx_tenant_package_tenant_id")
  @@index([packageId], map: "idx_tenant_package_package_id")
  @@map("tenant_package")
}

model TenantToolOverride {
  id           String   @id @default(uuid()) @db.Uuid
  tenantId     String   @map("tenant_id") @db.Uuid
  toolId       String?  @map("tool_id") @db.Uuid
  toolActionId String?  @map("tool_action_id") @db.Uuid
  flags        Json?
  limits       Json?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  tenant       Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade, map: "fk_tenant_tool_override_tenant_id")
  tool         Tool?      @relation(fields: [toolId], references: [id], onDelete: Cascade, map: "fk_tenant_tool_override_tool_id")
  toolAction   ToolAction? @relation(fields: [toolActionId], references: [id], onDelete: Cascade, map: "fk_tenant_tool_override_tool_action_id")

  @@index([tenantId], map: "idx_tenant_tool_override_tenant_id")
  @@index([toolId], map: "idx_tenant_tool_override_tool_id")
  @@index([toolActionId], map: "idx_tenant_tool_override_tool_action_id")
  @@map("tenant_tool_override")
}

model User {
  id              String       @id @default(uuid()) @db.Uuid
  tenantId        String       @map("tenant_id") @db.Uuid
  email           String
  name            String
  status          Status       @default(ativo)
  authProvider    AuthProvider @default(internal) @map("auth_provider")
  suspendedReason String?      @map("suspended_reason")
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")
  deletedAt       DateTime?    @map("deleted_at")

  tenant          Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade, map: "fk_user_tenant_id")
  userGroups      UserGroup[]
  auditLogs       AuditLog[]
  refreshTokens   RefreshToken[]

  @@unique([tenantId, email], map: "uq_user_tenant_id_email")
  @@index([tenantId], map: "idx_user_tenant_id")
  @@map("user")
}

model Group {
  id              String    @id @default(uuid()) @db.Uuid
  tenantId        String    @map("tenant_id") @db.Uuid
  name            String
  description     String?
  status          Status    @default(ativo)
  suspendedReason String?   @map("suspended_reason")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade, map: "fk_group_tenant_id")
  userGroups      UserGroup[]
  permissions     GroupPermission[]

  @@unique([tenantId, name], map: "uq_group_tenant_id_name")
  @@index([tenantId], map: "idx_group_tenant_id")
  @@map("group")
}

model UserGroup {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  groupId   String   @map("group_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  tenant    Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade, map: "fk_user_group_tenant_id")
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade, map: "fk_user_group_user_id")
  group     Group  @relation(fields: [groupId], references: [id], onDelete: Cascade, map: "fk_user_group_group_id")

  @@unique([tenantId, userId, groupId], map: "uq_user_group_tenant_id_user_id_group_id")
  @@index([tenantId], map: "idx_user_group_tenant_id")
  @@index([userId], map: "idx_user_group_user_id")
  @@index([groupId], map: "idx_user_group_group_id")
  @@map("user_group")
}

model GroupPermission {
  id           String   @id @default(uuid()) @db.Uuid
  tenantId     String   @map("tenant_id") @db.Uuid
  groupId      String   @map("group_id") @db.Uuid
  toolActionId String   @map("tool_action_id") @db.Uuid
  constraints  Json?
  createdAt    DateTime @default(now()) @map("created_at")

  tenant       Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade, map: "fk_group_permission_tenant_id")
  group        Group      @relation(fields: [groupId], references: [id], onDelete: Cascade, map: "fk_group_permission_group_id")
  toolAction   ToolAction @relation(fields: [toolActionId], references: [id], onDelete: Restrict, map: "fk_group_permission_tool_action_id")

  @@unique([tenantId, groupId, toolActionId], map: "uq_group_permission_tenant_id_group_id_tool_action_id")
  @@index([tenantId], map: "idx_group_permission_tenant_id")
  @@index([groupId], map: "idx_group_permission_group_id")
  @@index([toolActionId], map: "idx_group_permission_tool_action_id")
  @@map("group_permission")
}

model ApiKey {
  id         String        @id @default(uuid()) @db.Uuid
  tenantId   String        @map("tenant_id") @db.Uuid
  name       String
  profile    ApiKeyProfile?
  hash       String        @unique(map: "uq_api_key_hash")
  expiresAt  DateTime?     @map("expires_at")
  lastUsedAt DateTime?     @map("last_used_at")
  status     Status        @default(ativo)
  createdAt  DateTime      @default(now()) @map("created_at")
  updatedAt  DateTime      @updatedAt @map("updated_at")

  tenant     Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade, map: "fk_api_key_tenant_id")
  toolActions ApiKeyToolAction[]

  @@unique([tenantId, name], map: "uq_api_key_tenant_id_name")
  @@index([tenantId], map: "idx_api_key_tenant_id")
  @@map("api_key")
}

model ApiKeyToolAction {
  id           String   @id @default(uuid()) @db.Uuid
  tenantId     String   @map("tenant_id") @db.Uuid
  apiKeyId     String   @map("api_key_id") @db.Uuid
  toolActionId String   @map("tool_action_id") @db.Uuid
  createdAt    DateTime @default(now()) @map("created_at")

  tenant       Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade, map: "fk_api_key_tool_action_tenant_id")
  apiKey       ApiKey     @relation(fields: [apiKeyId], references: [id], onDelete: Cascade, map: "fk_api_key_tool_action_api_key_id")
  toolAction   ToolAction @relation(fields: [toolActionId], references: [id], onDelete: Restrict, map: "fk_api_key_tool_action_tool_action_id")

  @@unique([tenantId, apiKeyId, toolActionId], map: "uq_api_key_tool_action_tenant_id_api_key_id_tool_action_id")
  @@index([tenantId], map: "idx_api_key_tool_action_tenant_id")
  @@index([apiKeyId], map: "idx_api_key_tool_action_api_key_id")
  @@index([toolActionId], map: "idx_api_key_tool_action_tool_action_id")
  @@map("api_key_tool_action")
}

model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  jti       String
  hash      String
  expiresAt DateTime @map("expires_at")
  revokedAt DateTime? @map("revoked_at")
  createdAt DateTime @default(now()) @map("created_at")

  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade, map: "fk_refresh_token_tenant_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade, map: "fk_refresh_token_user_id")

  @@unique([tenantId, jti], map: "uq_refresh_token_tenant_id_jti")
  @@index([tenantId], map: "idx_refresh_token_tenant_id")
  @@index([userId], map: "idx_refresh_token_user_id")
  @@map("refresh_token")
}

model AuditLog {
  id          String    @id @default(uuid()) @db.Uuid
  tenantId    String    @map("tenant_id") @db.Uuid
  actorUserId String?   @map("actor_user_id") @db.Uuid
  actorType   ActorType @map("actor_type")
  action      String
  entityType  String    @map("entity_type")
  entityId    String?   @map("entity_id")
  metadata    Json?
  ip          String?
  userAgent   String?   @map("user_agent")
  createdAt   DateTime  @default(now()) @map("created_at")

  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade, map: "fk_audit_log_tenant_id")
  actorUser   User?     @relation(fields: [actorUserId], references: [id], onDelete: SetNull, map: "fk_audit_log_actor_user_id")

  @@index([tenantId, createdAt], map: "idx_audit_log_tenant_id_created_at")
  @@map("audit_log")
}

model IdempotencyKey {
  id           String   @id @default(uuid()) @db.Uuid
  tenantId     String   @map("tenant_id") @db.Uuid
  key          String
  handler      String
  requestHash  String   @map("request_hash")
  responseStatus Int    @map("response_status")
  responseBody Json    @map("response_body")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade, map: "fk_idempotency_key_tenant_id")

  @@unique([tenantId, key, handler], map: "uq_idempotency_key_tenant_id_key_handler")
  @@index([tenantId], map: "idx_idempotency_key_tenant_id")
  @@map("idempotency_key")
}

model OutboxJob {
  id          String      @id @default(uuid()) @db.Uuid
  tenantId    String?     @map("tenant_id") @db.Uuid
  type        String
  payload     Json
  status      OutboxStatus @default(pending)
  retries     Int         @default(0)
  availableAt DateTime    @default(now()) @map("available_at")
  lastError   String?     @map("last_error")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  tenant      Tenant?     @relation(fields: [tenantId], references: [id], onDelete: Cascade, map: "fk_outbox_job_tenant_id")

  @@index([status, availableAt], map: "idx_outbox_job_status_available_at")
  @@index([tenantId], map: "idx_outbox_job_tenant_id")
  @@map("outbox_job")
}

model UsageMetric {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  toolActionId String  @map("tool_action_id") @db.Uuid
  periodStart DateTime @map("period_start")
  periodEnd   DateTime @map("period_end")
  count       Int

  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade, map: "fk_usage_metric_tenant_id")
  toolAction  ToolAction @relation(fields: [toolActionId], references: [id], onDelete: Restrict, map: "fk_usage_metric_tool_action_id")

  @@unique([tenantId, toolActionId, periodStart, periodEnd], map: "uq_usage_metric_tenant_action_period")
  @@index([tenantId, periodStart], map: "idx_usage_metric_tenant_id_period_start")
  @@map("usage_metric")
}

model IntegrationCredential {
  id            String   @id @default(uuid()) @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  provider      String
  name          String
  dataEncrypted String   @map("data_encrypted")
  expiresAt     DateTime? @map("expires_at")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade, map: "fk_integration_credential_tenant_id")

  @@index([tenantId], map: "idx_integration_credential_tenant_id")
  @@map("integration_credential")
}

model TenantConfig {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @unique(map: "uq_tenant_config_tenant_id") @map("tenant_id") @db.Uuid
  flags     Json?
  limits    Json?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade, map: "fk_tenant_config_tenant_id")

  @@map("tenant_config")
}

model TenantBranding {
  id             String   @id @default(uuid()) @db.Uuid
  tenantId       String   @unique(map: "uq_tenant_branding_tenant_id") @map("tenant_id") @db.Uuid
  logoUrl        String?  @map("logo_url")
  primaryColor   String?  @map("primary_color")
  secondaryColor String?  @map("secondary_color")
  domain         String?
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  tenant         Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade, map: "fk_tenant_branding_tenant_id")

  @@map("tenant_branding")
}

model WebhookSubscription {
  id        String        @id @default(uuid()) @db.Uuid
  tenantId  String        @map("tenant_id") @db.Uuid
  url       String
  secret    String
  events    String[]      @default([])
  status    WebhookStatus @default(ativo)
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")

  tenant    Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade, map: "fk_webhook_subscription_tenant_id")
  deliveries WebhookDelivery[]

  @@index([tenantId], map: "idx_webhook_subscription_tenant_id")
  @@map("webhook_subscription")
}

model WebhookDelivery {
  id             String               @id @default(uuid()) @db.Uuid
  tenantId       String               @map("tenant_id") @db.Uuid
  subscriptionId String               @map("subscription_id") @db.Uuid
  eventType      String               @map("event_type")
  eventId        String               @map("event_id")
  payload        Json
  status         WebhookDeliveryStatus @default(pending)
  attempts       Int                  @default(0)
  nextAttemptAt  DateTime?            @map("next_attempt_at")
  lastAttemptAt  DateTime?            @map("last_attempt_at")
  responseStatus Int?                 @map("response_status")
  responseBody   String?              @map("response_body")
  lastError      String?              @map("last_error")
  createdAt      DateTime             @default(now()) @map("created_at")
  updatedAt      DateTime             @updatedAt @map("updated_at")

  tenant         Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade, map: "fk_webhook_delivery_tenant_id")
  subscription   WebhookSubscription  @relation(fields: [subscriptionId], references: [id], onDelete: Cascade, map: "fk_webhook_delivery_subscription_id")

  @@unique([subscriptionId, eventId], map: "uq_webhook_delivery_subscription_id_event_id")
  @@index([tenantId, createdAt], map: "idx_webhook_delivery_tenant_id_created_at")
  @@index([status, nextAttemptAt], map: "idx_webhook_delivery_status_next_attempt_at")
  @@map("webhook_delivery")
}
